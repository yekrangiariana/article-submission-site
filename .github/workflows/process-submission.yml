# GitHub Actions workflow for processing article submissions
# This workflow is triggered when an issue is labeled with 'submission:approved'
# It extracts the markdown content and creates a Pull Request

name: Process Article Submission

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  process-submission:
    # Only run when the 'submission:approved' label is added
    if: github.event.label.name == 'submission:approved'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract submission data
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body;

            // Extract metadata from the issue table
            const titleMatch = body.match(/\*\*Title\*\*\s*\|\s*([^\n|]+)/);
            const slugMatch = body.match(/\*\*Slug\*\*\s*\|\s*([^\n|]+)/);
            const typeMatch = body.match(/\*\*Type\*\*\s*\|\s*([^\n|]+)/);

            // Extract markdown content from the code block
            const markdownMatch = body.match(/```markdown\n([\s\S]*?)\n```/);

            if (!titleMatch || !slugMatch || !markdownMatch) {
              core.setFailed('Could not parse submission data from issue body');
              return;
            }

            const title = titleMatch[1].trim();
            const slug = slugMatch[1].trim();
            const type = typeMatch ? typeMatch[1].trim().toLowerCase() : 'general article';
            const markdown = markdownMatch[1];

            // Extract date from front matter (format: date: 2026-02-28T19:23:00+0300)
            const dateMatch = markdown.match(/date:\s*["']?(\d{4})-(\d{2})-(\d{2})/);
            let datePrefix = '';
            if (dateMatch) {
              const [, year, month, day] = dateMatch;
              datePrefix = `${year}-${month}-${day}-`;
            } else {
              // Fallback to today's date
              const now = new Date();
              const day = String(now.getDate()).padStart(2, '0');
              const month = String(now.getMonth() + 1).padStart(2, '0');
              const year = now.getFullYear();
              datePrefix = `${year}-${month}-${day}-`;
            }

            // Determine content path based on type
            const isEssentials = type.includes('essentials');
            const contentPath = isEssentials ? 'content/essentials' : 'content/posts';
            const fileName = `${datePrefix}${slug}.md`;
            const filePath = `${contentPath}/${fileName}`;

            // Set outputs
            core.setOutput('title', title);
            core.setOutput('slug', slug);
            core.setOutput('type', type);
            core.setOutput('file_path', filePath);
            core.setOutput('file_name', fileName);
            core.setOutput('branch_name', `submission/${datePrefix}${slug}`);

            // Write markdown to file for later step
            const fs = require('fs');
            fs.writeFileSync('/tmp/article-content.md', markdown);

            console.log(`Processing submission: ${title}`);
            console.log(`Type: ${type}`);
            console.log(`Will create: ${filePath}`);

      - name: Create submission branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH_NAME="${{ steps.extract.outputs.branch_name }}"

          # Delete branch if it exists (for re-processing)
          git push origin --delete "$BRANCH_NAME" 2>/dev/null || true

          # Create new branch
          git checkout -b "$BRANCH_NAME"

      - name: Create content file
        run: |
          FILE_PATH="${{ steps.extract.outputs.file_path }}"

          # Ensure directory exists
          mkdir -p "$(dirname "$FILE_PATH")"

          # Copy article content
          cp /tmp/article-content.md "$FILE_PATH"

          # Commit the file
          git add "$FILE_PATH"
          git commit -m "Add article: ${{ steps.extract.outputs.title }}

          Submitted via #${{ github.event.issue.number }}

          Co-authored-by: ${{ github.event.issue.user.login }} <${{ github.event.issue.user.id }}+${{ github.event.issue.user.login }}@users.noreply.github.com>"

      - name: Push branch
        run: |
          git push origin "${{ steps.extract.outputs.branch_name }}"

      - name: Create Pull Request
        id: create-pr
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const slug = '${{ steps.extract.outputs.slug }}';
            const title = '${{ steps.extract.outputs.title }}';
            const filePath = '${{ steps.extract.outputs.file_path }}';
            const branchName = '${{ steps.extract.outputs.branch_name }}';
            const type = '${{ steps.extract.outputs.type }}';

            // Get the default branch
            const { data: repoData } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            const defaultBranch = repoData.default_branch;

            // Create PR
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üìù ${title}`,
              head: branchName,
              base: defaultBranch,
              body: `## Article Submission

            This PR was automatically created from issue #${issue.number}.

            | Field | Value |
            |-------|-------|
            | **Type** | ${type} |
            | **Title** | ${title} |
            | **File** | \`${filePath}\` |
            | **Submitted by** | @${issue.user.login} |
            | **Issue** | #${issue.number} |

            ---

            ### Review Checklist

            - [ ] Content reviewed for accuracy
            - [ ] Formatting verified
            - [ ] Images/media added (if applicable)
            - [ ] Ready for publication

            ---

            **Merge this PR** to publish the article to the site.

            _Closes #${issue.number}_
            `,
              draft: false
            });

            console.log(`Created PR #${pr.data.number}`);
            core.setOutput('pr_number', pr.data.number);
            core.setOutput('pr_url', pr.data.html_url);

            return pr.data;

      - name: Update issue with PR link
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const prNumber = '${{ steps.create-pr.outputs.pr_number }}';
            const prUrl = '${{ steps.create-pr.outputs.pr_url }}';

            // Add comment to issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `‚úÖ **Submission approved!**

            A pull request has been created: #${prNumber}

            The article will be published once the PR is merged.

            [View Pull Request](${prUrl})`
            });

            // Add label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: ['submission:processing']
            });

            // Remove pending label
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                name: 'submission:pending'
              });
            } catch (e) {
              // Label might not exist, ignore
            }

  # Handle rejected submissions
  reject-submission:
    if: github.event.label.name == 'submission:rejected'
    runs-on: ubuntu-latest

    steps:
      - name: Comment and close issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `Thank you for your submission. Unfortunately, we are unable to accept this article at this time.

            If you have questions about this decision, please feel free to reach out to the editorial team.`
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed'
            });
